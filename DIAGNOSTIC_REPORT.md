# üîç Sales Analytics System - Diagnostic Report

**–î–∞—Ç–∞**: 27 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ

---

## üìä –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ RPC —Ñ—É–Ω–∫—Ü–∏–π –≤ Supabase

**–°–∏–º–ø—Ç–æ–º—ã:**
```
RPC not available for top-products: {
  'code': '42702', 
  'message': 'column reference "total_revenue" is ambiguous'
}
```

**–ü—Ä–∏—á–∏–Ω–∞:**
Backend –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–∑–≤–∞—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é `get_top_products_by_sales()`, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

**–í–ª–∏—è–Ω–∏–µ:**
- Endpoint `/api/analytics/top-products` —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ fallback (–º–µ–¥–ª–µ–Ω–Ω–µ–µ)
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
- –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
‚úÖ –°–æ–∑–¥–∞–Ω SQL —Å–∫—Ä–∏–ø—Ç: `database/create_analytics_functions.sql`  
‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `docs/FIX_ANALYTICS_RPC.md`  
‚úÖ –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: `QUICKFIX_RU.md`

### 2. ‚ö†Ô∏è –ù–ï–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç OPENAI_API_KEY

**–°–∏–º–ø—Ç–æ–º—ã:**
AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.

**–í–ª–∏—è–Ω–∏–µ:**
- –§—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/ai-assistant` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤—å—Ç–µ OPENAI_API_KEY –≤ `.env` —Ñ–∞–π–ª:
```bash
OPENAI_API_KEY=sk-...
```

### 3. ‚ö†Ô∏è –ù–ï–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: Plotly –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Importing plotly failed. Interactive plots will not work.
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
- –ë–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```bash
.venv/bin/pip install plotly
```

### 4. ‚ÑπÔ∏è –ò–ù–§–û–†–ú–ê–¶–ò–Ø: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ OpenSSL

**–°–∏–º–ø—Ç–æ–º—ã:**
```
urllib3 v2 only supports OpenSSL 1.1.1+, currently 'LibreSSL 2.8.3'
```

**–í–ª–∏—è–Ω–∏–µ:**
–ù–µ—Ç (–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ macOS)

**–†–µ—à–µ–Ω–∏–µ:**
–ú–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è macOS.

---

## üõ†Ô∏è –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### 1. SQL –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RPC
**–§–∞–π–ª**: `database/create_analytics_functions.sql`

–°–æ–∑–¥–∞–µ—Ç 3 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `get_top_products_by_sales(limit, days)` - —Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
- `get_top_customers_by_revenue(limit, days)` - —Ç–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤
- `get_sales_trend(period)` - —Ç—Ä–µ–Ω–¥ –ø—Ä–æ–¥–∞–∂

### 2. –°–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
**–§–∞–π–ª**: `scripts/diagnose.sh`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- ‚úÖ –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ (backend, frontend)
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (.env)
- ‚úÖ –õ–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ API endpoints
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- ‚úÖ Python/Node.js –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- ‚úÖ –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
./scripts/diagnose.sh
```

### 3. –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
**–§–∞–π–ª**: `scripts/fix_rpc_quick.py`

–ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å SQL:
- –ß–∏—Ç–∞–µ—Ç SQL —Ñ–∞–π–ª
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –ö–æ–ø–∏—Ä—É–µ—Ç SQL –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (macOS)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
.venv/bin/python scripts/fix_rpc_quick.py
```

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ**: `docs/FIX_ANALYTICS_RPC.md`
- –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π
- Troubleshooting

**–ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ**: `QUICKFIX_RU.md`
- –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (5 –º–∏–Ω—É—Ç)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —à–∞–≥–∏

---

## ‚úÖ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (5 –º–∏–Ω—É—Ç)

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏–∏:**
   ```bash
   # –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL
   .venv/bin/python scripts/fix_rpc_quick.py
   
   # –ó–∞—Ç–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å –≤ Supabase SQL Editor:
   # https://app.supabase.com/project/hnunemnxpmyhexzcvmtb/sql
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend:**
   ```bash
   ./stop.sh && ./start.sh
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```bash
   ./scripts/diagnose.sh
   ```

### –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è

4. **–î–æ–±–∞–≤–∏—Ç—å OpenAI –∫–ª—é—á** (–¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞):
   ```bash
   echo "OPENAI_API_KEY=sk-..." >> .env
   ```

5. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Plotly** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```bash
   .venv/bin/pip install plotly
   ```

---

## üìà –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- Backend API (http://localhost:8000)
- Frontend UI (http://localhost:3000)
- Dashboard –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- Agent Analytics
- Geo Analytics
- ABC-XYZ –∞–Ω–∞–ª–∏–∑
- LFL –∞–Ω–∞–ª–∏–∑
- Boston Matrix
- Forecast

### ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ fallback (–º–µ–¥–ª–µ–Ω–Ω–µ–µ)
- Top Products endpoint
- Top Customers endpoint
- Sales Trend

### ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- AI Chat Assistant (–Ω–µ—Ç OPENAI_API_KEY)
- Interactive Plotly plots

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RPC —Ñ—É–Ω–∫—Ü–∏–π:

1. ‚úÖ –û—à–∏–±–∫–∞ "ambiguous column" –∏—Å—á–µ–∑–Ω–µ—Ç
2. ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —É–ª—É—á—à–∏—Ç—Å—è
3. ‚úÖ –õ–æ–≥–∏ —Å—Ç–∞–Ω—É—Ç —á–∏—â–µ (–º–µ–Ω—å—à–µ warnings)
4. ‚úÖ Endpoints –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## üìû –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
./scripts/diagnose.sh

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
tail -f backend.log
tail -f frontend.log

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
./stop.sh
./start.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
./status.sh

# API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
open http://localhost:8000/docs
```

### –§–∞–π–ª—ã –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏

- `docs/FIX_ANALYTICS_RPC.md` - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `QUICKFIX_RU.md` - –∫—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- `database/create_analytics_functions.sql` - SQL –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- `backend.log` - –ª–æ–≥–∏ backend
- `frontend.log` - –ª–æ–≥–∏ frontend

---

**–ê–≤—Ç–æ—Ä**: Antigravity AI Assistant  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 27 —è–Ω–≤–∞—Ä—è 2025, 15:45
